{% extends "base.html" %}
{% from "_form_helpers.html" import render_field %}

{% block title %}{{ action }} Invoice{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>{{ action }} Invoice</h2>
    <form method="POST" novalidate>
        {{ form.hidden_tag() }} {# CSRF Token and other hidden fields #}

        <div class="row">
            <div class="col-md-4">
                {{ render_field(form.invoice_number, class="form-control") }}
            </div>
            <div class="col-md-4">
                {{ render_field(form.date, class="form-control") }}
            </div>
            <div class="col-md-4">
                {{ render_field(form.invoice_type, class="form-check-input") }}
            </div>
        </div>

        <div class="row">
            <div class="col-md-6" id="customer-field">
                {{ render_field(form.customer_id, class="form-select") }}
            </div>
            <div class="col-md-6" id="vendor-field" style="display: none;">
                {{ render_field(form.vendor_id, class="form-select") }}
            </div>
        </div>

        <hr>
        <h4>Invoice Items</h4>
        <div id="invoice-items-container">
            {# Render existing items for the "Edit" form #}
            {% for item_form in form.items %}
                <div class="row mb-2 invoice-item">
                    <div class="col-md-4">
                        {{ render_field(item_form.description, class="form-control", placeholder="Description") }}
                    </div>
                    <div class="col-md-2">
                        {{ render_field(item_form.quantity, class="form-control", placeholder="Quantity") }}
                    </div>
                    <div class="col-md-2">
                        {{ render_field(item_form.unit_price, class="form-control", placeholder="Unit Price") }}
                    </div>
                    <div class="col-md-2">
                        {{ render_field(item_form.vat_rate, class="form-control", placeholder="VAT Rate") }}
                    </div>
                    <div class="col-md-2 align-self-center">
                        <button type="button" class="btn btn-danger remove-item-btn">Remove</button>
                    </div>
                </div>
            {% endfor %}
        </div>
        <button type="button" id="add-item-btn" class="btn btn-info mt-2">Add Item</button>
        <hr>

        {{ form.submit(class="btn btn-primary") }}
        <a href="{{ url_for('accounts.list_invoices') }}" class="btn btn-secondary">Cancel</a>
    </form>
</div>

{# Template for new items, used by JavaScript #}
<template id="invoice-item-template">
    <div class="row mb-2 invoice-item">
        <div class="col-md-4">
            {{ render_field(form.items.append_entry().description, class="form-control", placeholder="Description") }}
        </div>
        <div class="col-md-2">
            {{ render_field(form.items.append_entry().quantity, class="form-control", placeholder="Quantity") }}
        </div>
        <div class="col-md-2">
            {{ render_field(form.items.append_entry().unit_price, class="form-control", placeholder="Unit Price") }}
        </div>
        <div class="col-md-2">
            {{ render_field(form.items.append_entry().vat_rate, class="form-control", placeholder="VAT Rate") }}
        </div>
        <div class="col-md-2 align-self-center">
            <button type="button" class="btn btn-danger remove-item-btn">Remove</button>
        </div>
    </div>
</template>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const invoiceTypeRadios = document.querySelectorAll('input[name="invoice_type"]');
    const customerField = document.getElementById('customer-field');
    const vendorField = document.getElementById('vendor-field');

    function togglePartyFields() {
        const selectedType = document.querySelector('input[name="invoice_type"]:checked').value;
        if (selectedType === 'sales') {
            customerField.style.display = 'block';
            vendorField.style.display = 'none';
        } else {
            vendorField.style.display = 'block';
            customerField.style.display = 'none';
        }
    }

    invoiceTypeRadios.forEach(radio => radio.addEventListener('change', togglePartyFields));
    togglePartyFields(); // Initial check on page load

    // --- Dynamic invoice items ---
    const container = document.getElementById('invoice-items-container');
    const addItemBtn = document.getElementById('add-item-btn');
    const template = document.getElementById('invoice-item-template');
    // Get the initial count of items from the form
    let itemIndex = container.querySelectorAll('.invoice-item').length;

    addItemBtn.addEventListener('click', function() {
        // Clone the template
        const clone = template.content.cloneNode(true);
        // Update the name attributes with the new index
        clone.querySelectorAll('[name]').forEach(el => {
            el.name = el.name.replace(/items-\d-/, `items-${itemIndex}-`);
            el.id = el.id.replace(/items-\d-/, `items-${itemIndex}-`);
        });
        container.appendChild(clone);
        itemIndex++;
    });

    container.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('remove-item-btn')) {
            e.target.closest('.invoice-item').remove();
        }
    });
});
</script>
{% endblock %}
